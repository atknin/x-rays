{% extends "general/index.html" %}
  {% block title %}
  <title>ТРС конвертер </title>
  {% load static %}
    <script src="{% static "graph/plotly/plotly-latest.min.js"%}" ></script>
    <style>
    .plot{
      height: 300px;
    }
    textarea.Whiteboard{
      resize: none;
      border: none;
      font-size: 10px;
      height: 300px;
      
      white-space: normal;
      text-align: justify;
      -moz-text-align-last: center;
      text-align-last: center;
    }
    </style>
  {% endblock %}
  {% block content %}

  <div class="row" style=" background-color: #F7F7F9; height: 145px;" >
    <div class="input-group">
        <div class="col-md-4" style="margin: 50px;">
          <label class="btn btn-default btn-file">
            <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
            <input type="file" multiple id="geomInputFile" style="display: none;">
          </label>
        </div>
        <div class="col-md-6">
          <div style="margin-top: 20px;" class="alert alert-info" role="alert"><samp>Не добавлять не правильные файлы (картинки...) - НЕТ ПРОВЕРКИ. Работает Мильтизагрузка, выделить нужное колличество файлов в окне ввода. Желательно перезагружать страницу перед началом новой загрузки.</samp></div>
        </div>

        
        
    </div>
  </div>
  <div class="row" style="margin-top: 50px;" id = 'text_for_x_y'>      
  </div>

  </div>
    

<script type="text/javascript">
    var num = 0;
    var name_aa = [];
    $(document).ready(function(){
      $('#geomInputFile').on('change', function(e){
          $( "#text_for_x_y" ).empty();
          for (var i = 0; i < this.files.length; i++) {
              name_aa[i] = (this.files[i].name);
              readFile(this.files[i], function(e) {
                // use result in callback...
              ok(e.target);
            });
          };
          
      });
    });


    function ok(text){
      var new_txt = text.result.split('\n');
      data = {};

      data['method'] = new_txt[0];
      data['scan_from'] = parseFloat(new_txt[2]);
      data['shag'] = parseFloat(new_txt[3]);
      data['how_many_detectors'] = parseFloat(new_txt[4]);
      data['points_1'] = parseInt(new_txt[5]);
      data['points_2'] = parseInt(new_txt[6]);
      data['body'] = [];
      data['x'] = [];
      
      // console.log(data['x'].length);

      new_txt.splice(0,7);
      var ind = 0;
      for (var i = 0; i < new_txt.length; i++) {
        inside = new_txt[i].split(' ');
        for (var j = 0; j < inside.length; j++) {
          if (!isNaN(parseFloat(inside[j]))) {
            data['body'][ind] = parseFloat(inside[j]);
            ind++;
          }
          
        };
      };

      l1 = data['body'].splice(0,data['points_1']);
      l2 = data['body'];
      var to_out1 = '';
      var to_out2 = '';
      for (var i = 0; i < data['points_1']; i++) {
          data['x'][i]= data['scan_from'] + i*data['shag'];
          to_out1+= data['x'][i] + '\t' + l1[i]  + '\n'
          to_out2+= data['x'][i] + '\t' + l2[i] + '\n'
      };
  
      $( "#text_for_x_y" ).append( "<div class='row' id = 'num_row_"+num+"'><hr></div>" );
      $( "#num_row_"+num).append( "<div class='col-md-4 plot' id = 'myDiv_left_"+num+"'></div>" );

      $( "#num_row_"+num ).append( "<div class='col-md-2 plot' id = 'myDiv_center_left_"+num+"'><textarea class='form-control Whiteboard' id = 'num_scan_left_"+num+"' rows='10'></textarea></div>" );

      $( "#num_row_"+num ).append( "<div class='col-md-2 plot' id = 'myDiv_center_right_"+num+"'><textarea class='form-control Whiteboard' id = 'num_scan_right_"+num+"' rows='10'></textarea></div>" );

      $( "#num_row_" +num).append( "<div class='col-md-4 plot' id = 'myDiv_right_"+num+"'></div>" );


      $( '#num_scan_left_'+num).val(to_out1);
      $( '#num_scan_right_'+num).val(to_out2);


      var trace1 = {
        x: data['x'], 
        y: l1, 
        type: 'scatter'
      };

      var data_1 = [trace1];

      var layout_1 = {
        title: name_aa[num],
        xaxis: {
          title: 'отстройка, сек',
          titlefont: {
            family: 'Courier New, monospace',
            size: 18,
            color: '#7f7f7f'
          }
      },
      yaxis: {
        title: 'Интенсивность отс.',
        titlefont: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      }
      };
      Plotly.newPlot('myDiv_left_'+num, data_1, layout_1);

      var trace2 = {
        x: data['x'], 
        y: l2, 
        type: 'scatter'
      };

      var data_2 = [trace2];

      var layout_2 = {
      title: name_aa[num],
      xaxis: {
        title: 'отстройка, сек',
        titlefont: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      },
      yaxis: {
        title: 'Интенсивность отс.',
        titlefont: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      }
      };
      Plotly.newPlot('myDiv_right_'+num, data_2, layout_2);


      num++;

    };

    function readFile(file, onLoadCallback){
      var reader = new FileReader();
      reader.onload = onLoadCallback;
      reader.readAsText(file);
    };
</script>
  {% endblock %}