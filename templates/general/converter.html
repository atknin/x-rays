{% extends "general/index.html" %}
  {% block title %}
  <title>ТРС конвертер </title>
  {% load static %}
    <script src="{% static "graph/plotly/plotly-latest.min.js"%}" ></script>
    <style>
    .plot{
      height: 300px;
    }
    textarea.Whiteboard{
      resize: none;
      border: none;
      font-size: 10px;
      height: 300px;
      
      white-space: normal;
      text-align: justify;
      -moz-text-align-last: center;
      text-align-last: center;
    }
    </style>
  {% endblock %}
  {% block content %}

  <div class="row" style=" background-color: #F7F7F9; height: 145px;" >
    <div class="col-md-4" style="margin: 50px;">
      <div class="input-group">
        <label class="btn btn-default btn-file">
          <span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span>
          <input type="file" multiple id="geomInputFile" style="display: none;">
        </label>
      </div>
    </div>
    <div class="col-md-6" style="margin-top: 50px" >
      <a href="#" id = 'id_compute_all_files' > <span class="label label-primary image"><sup>*</sup>.txt</span></a>
    </div>
  </div>
  <div class="row" style="margin-top: 50px;" id = 'text_for_x_y'>  
  <div id="grid_array" style="margin-top:100px; margin-bottom:100px;"></div>
  <hr>
    
  </div>

  </div>
    

<script type="text/javascript">
    var num = 0;
    var name_aa = [];
    var scan_data = {};
    $('#id_compute_all_files').hide();
    $(document).ready(function(){
      $('#geomInputFile').on('change', function(e){
          $('#id_compute_all_files').show();
          $( "#text_for_x_y" ).empty();
          for (var i = 0; i < this.files.length; i++) {
              name_aa[i] = (this.files[i].name);
              readFile(this.files[i], function(e) {
                // use result in callback...
              ok(e.target);
            });
          };
          
      });
      $('#id_compute_all_files').on('click', function(){
        $(function () {
  var data = [[1, 'Exxon Mobil', '339,938.0', '36,130.0'],
      [2, 'Wal-Mart Stores', '315,654.0', '11,231.0'],
      [3, 'Royal Dutch Shell', '306,731.0', '25,311.0'],
      [4, 'BP', '267,600.0', '22,341.0'],
      [5, 'General Motors', '192,604.0', '-10,567.0'],
      [6, 'Chevron', '189,481.0', '14,099.0'],
      [7, 'DaimlerChrysler', '186,106.3', '3,536.3'],
      [8, 'Toyota Motor', '185,805.0', '12,119.6'],
      [9, 'Ford Motor', '177,210.0', '2,024.0'],
      [10, 'ConocoPhillips', '166,683.0', '13,529.0'],
      [11, 'General Electric', '157,153.0', '16,353.0'],
      [12, 'Total', '152,360.7', '15,250.0'],
      [13, 'ING Group', '138,235.3', '8,958.9'],
      [14, 'Citigroup', '131,045.0', '24,589.0'],
      [15, 'AXA', '129,839.2', '5,186.5'],
      [16, 'Allianz', '121,406.0', '5,442.4'],
      [17, 'Volkswagen', '118,376.6', '1,391.7'],
      [18, 'Fortis', '112,351.4', '4,896.3'],
      [19, 'Crit Agricole', '110,764.6', '7,434.3'],
      [20, 'American Intl. Group', '108,905.0', '10,477.0']];


  var obj = { width: 700, height: 400, title: "ParamQuery Grid Example",resizable:true,draggable:true };
  obj.colModel = [{ title: "Rank", width: 100, dataType: "integer" },
    { title: "Company", width: 200, dataType: "string" },
    { title: "Revenues ($ millions)", width: 150, dataType: "float", align: "right" },
    { title: "Profits ($ millions)", width: 150, dataType: "float", align: "right"}];
  obj.dataModel = { data: data };
  
  $("#grid_array").pqGrid(obj);

}); 
      });
    });

   

    function ok(text){
      var new_txt = text.result.split('\n');
      data = {};

      data['method'] = new_txt[0];
      data['scan_from'] = parseFloat(new_txt[2]);
      data['shag'] = parseFloat(new_txt[3]);
      data['how_many_detectors'] = parseFloat(new_txt[4]);
      data['points_1'] = parseInt(new_txt[5]);
      data['points_2'] = parseInt(new_txt[6]);
      data['body'] = [];
      data['x'] = [];
      
      // console.log(data['x'].length);

      new_txt.splice(0,7);
      var ind = 0;
      for (var i = 0; i < new_txt.length; i++) {
        inside = new_txt[i].split(' ');
        for (var j = 0; j < inside.length; j++) {
          if (!isNaN(parseFloat(inside[j]))) {
            data['body'][ind] = parseFloat(inside[j]);
            ind++;
          }
          
        };
      };

      l1 = data['body'].splice(0,data['points_1']);
      l2 = data['body'];
      var to_out1 = '';
      var to_out2 = '';

      for (var i = 0; i < data['points_1']; i++) {
          data['x'][i]= data['scan_from'] + i*data['shag'];
          to_out1+= data['x'][i] + '\t' + l1[i]  + '\n'
          to_out2+= data['x'][i] + '\t' + l2[i] + '\n'
      };
      scan_data[num] = {"x":data['x'],"y1":l1,"y2":l2};
  
      $( "#text_for_x_y" ).append( "<div class='row' id = 'num_row_"+num+"'><hr></div>" );
      $( "#num_row_"+num).append( "<div class='col-md-4 plot' id = 'myDiv_left_"+num+"'></div>" );

      $( "#num_row_"+num ).append( "<div class='col-md-2 plot' id = 'myDiv_center_left_"+num+"'><textarea class='form-control Whiteboard' id = 'num_scan_left_"+num+"' rows='10'></textarea></div>" );

      $( "#num_row_"+num ).append( "<div class='col-md-2 plot' id = 'myDiv_center_right_"+num+"'><textarea class='form-control Whiteboard' id = 'num_scan_right_"+num+"' rows='10'></textarea></div>" );

      $( "#num_row_" +num).append( "<div class='col-md-4 plot' id = 'myDiv_right_"+num+"'></div>" );


      $( '#num_scan_left_'+num).val(to_out1);
      $( '#num_scan_right_'+num).val(to_out2);


      var trace1 = {
        x: data['x'], 
        y: l1, 
        type: 'scatter'
      };

      var data_1 = [trace1];

      var layout_1 = {
        title: name_aa[num],
        xaxis: {
          title: 'отстройка, сек',
          titlefont: {
            family: 'Courier New, monospace',
            size: 18,
            color: '#7f7f7f'
          }
      },
      yaxis: {
        title: 'Интенсивность отс.',
        titlefont: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      }
      };
      Plotly.newPlot('myDiv_left_'+num, data_1, layout_1);

      var trace2 = {
        x: data['x'], 
        y: l2, 
        type: 'scatter'
      };

      var data_2 = [trace2];

      var layout_2 = {
      title: name_aa[num],
      xaxis: {
        title: 'отстройка, сек',
        titlefont: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      },
      yaxis: {
        title: 'Интенсивность отс.',
        titlefont: {
          family: 'Courier New, monospace',
          size: 18,
          color: '#7f7f7f'
        }
      }
      };
      Plotly.newPlot('myDiv_right_'+num, data_2, layout_2);
      num++;
    };

    function readFile(file, onLoadCallback){
      var reader = new FileReader();
      reader.onload = onLoadCallback;
      reader.readAsText(file);
    };
    
</script>
  {% endblock %}